location: Switzerland North
properties:
  managedEnvironmentId: /subscriptions/3c92b75f-68ec-4277-9ea8-daffa476f206/resourceGroups/rg-SeislerdütschesWörterbuech-prod/providers/Microsoft.App/managedEnvironments/managedEnvironment-rgSeislerdtsche-a893

  configuration:
    secrets:
      - name: elastic-admin-password
        value: # Set password for elastic-admin-password
      - name : seislerduetscheswoerterbuechazurecrio-seislerduetscheswoerterbuech
        value : # Set password for seislerduetscheswoerterbuechazurecrio-seislerduetscheswoerterbuech
      
    ingress:
      external: true
      targetPort: 80 # Mapping traffic to proxy container
      transport: auto

  template:
    containers:
      - name: proxy
        image: seislerduetscheswoerterbuech.azurecr.io/proxy:latest
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: ELASTICSEARCH_URL # Internal URL for ES
            value: http://localhost:9200

      - name: backend
        # Updated: 03.04.2025 13:20 for ~12k words
        image: seislerduetscheswoerterbuech.azurecr.io/backend:latest
        resources:
          cpu: 0.5
          memory: 1Gi
        env:
          - name: ELASTIC_URL
            value: http://localhost:9200
          - name: ELASTIC_ADMIN_USERNAME
            value: elastic
          - name: ELASTIC_ADMIN_PASSWORD
            secretRef: elastic-admin-password
          - name: ELASTIC_INDEX
            value: dictionary
          - name: ELASTIC_READER_USERNAME
            value: dictionary_reader
          - name: ELASTIC_READER_PASSWORD
            value: thisisgonnabepublic

      - name: elasticsearch
        image: seislerduetscheswoerterbuech.azurecr.io/elasticsearch:latest
        resources:
          cpu: 1.0
          memory: 2Gi
        env:
          - name: ELASTIC_PASSWORD
            secretRef: elastic-admin-password
          - name: xpack.security.enabled
            value: true
          - name: xpack.security.http.ssl.enabled
            value: false
          - name: xpack.security.transport.ssl.enabled
            value: false
          - name: discovery.type
            value: single-node

    scale:
      minReplicas: 1
      maxReplicas: 10
      rules:
        - name: http-scaler
          http:
            metadata:
              concurrentRequests: "50"
